<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ –ò–≥—Ä–æ–≤–æ–π –•–∞–± –ù–∞–∑–∞—Ä</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); 
            color: white; font-family: 'Segoe UI', Arial, sans-serif; 
            min-height: 100vh; display: flex; flex-direction: column; 
            align-items: center; padding: 20px;
        }
        .header { font-size: clamp(2rem, 8vw, 6rem); margin: 20px 0; text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .status { font-size: 1.5rem; margin-bottom: 30px; padding: 15px 30px; background: rgba(255,255,255,0.1); border-radius: 20px; backdrop-filter: blur(10px); }
        .auth-buttons, .games-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 800px; }
        button { 
            font-size: clamp(1.2rem, 4vw, 2rem); padding: 20px 40px; border: none; 
            border-radius: 25px; background: rgba(255,255,255,0.2); color: white; 
            cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s; min-height: 80px;
        }
        button:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); padding: 40px; border-radius: 25px; text-align: center; min-width: 300px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .modal input { width: 100%; padding: 15px; margin: 15px 0; border: none; border-radius: 15px; font-size: 1.1rem; }
        .error { color: #ff6b6b; margin-top: 10px; }
        .game-canvas { border: 3px solid rgba(255,255,255,0.3); border-radius: 15px; background: rgba(0,0,0,0.5); margin: 20px 0; }
        .leaderboard { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; margin: 20px 0; }
        .leaderboard h3 { margin-bottom: 15px; }
        .leader-item { display: flex; justify-content: space-between; padding: 8px 0; }
        @media (max-width: 600px) { .auth-buttons, .games-grid { flex-direction: column; align-items: center; } }
    </style>
</head>
<body>
    <h1 class="header">üéÆ –ò–≥—Ä–æ–≤–æ–π –•–∞–± –ù–∞–∑–∞—Ä</h1>
    <div class="status" id="status">üëã –ì–æ—Å—Ç—å</div>
    
    <div class="auth-buttons">
        <button onclick="showAuth('register')">üìù –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
        <button onclick="showAuth('login')">üîë –í–•–û–î</button>
        <button onclick="logout()" id="logout" style="display:none">üö™ –í—ã–π—Ç–∏</button>
        <button onclick="testAPI()">üß™ –¢–ï–°–¢</button>
    </div>

    <div class="games-grid">
        <button onclick="loadGame('guess')">üéØ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ</button>
        <button onclick="loadGame('snake')">üêç –ó–º–µ–π–∫–∞</button>
    </div>

    <div id="game-container" style="display:none; max-width: 600px; margin: 0 auto;">
        <canvas id="gameCanvas" class="game-canvas" width="500" height="400"></canvas>
        <div id="leaderboard" class="leaderboard" style="display:none">
            <h3>üèÜ –¢–û–ü-10</h3>
            <div id="leaders-list"></div>
        </div>
    </div>

    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="text" id="username" placeholder="–ò–º—è (nazar)" maxlength="20">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å (123456)">
            <div id="error" class="error"></div>
            <button onclick="authUser()" style="font-size:1.5rem;">‚úÖ –ì–û–¢–û–í–û</button>
            <button onclick="closeAuth()" style="background:rgba(255,0,0,0.3);">‚úï</button>
        </div>
    </div>

    <script>
        let currentGame = '';
        let isLoggedIn = false;
        
        async function checkUserStatus() {
            try {
                const res = await fetch('/status', {credentials: 'include'});
                const data = await res.json();
                if (data.logged_in) {
                    document.getElementById('status').textContent = `üëã ${data.username}`;
                    document.getElementById('logout').style.display = 'inline-block';
                    isLoggedIn = true;
                }
            } catch(e) {}
        }

        async function authUser() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const isRegister = document.getElementById('modal-title').textContent.includes('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è');
            const endpoint = isRegister ? '/register' : '/login';
            
            document.getElementById('error').textContent = '';
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('status').textContent = `üëã ${data.username}`;
                    document.getElementById('logout').style.display = 'inline-block';
                    closeAuth();
                    isLoggedIn = true;
                } else {
                    document.getElementById('error').textContent = data.error || '–û—à–∏–±–∫–∞';
                }
            } catch(e) {
                document.getElementById('error').textContent = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
            }
        }

        async function logout() {
            await fetch('/logout', {method: 'POST', credentials: 'include'});
            document.getElementById('status').textContent = 'üëã –ì–æ—Å—Ç—å';
            document.getElementById('logout').style.display = 'none';
            isLoggedIn = false;
        }

        async function loadGame(game) {
            currentGame = game;
            document.getElementById('game-container').style.display = 'block';
            if (game === 'guess') loadGuessGame();
            else if (game === 'snake') loadSnakeGame();
            loadLeaderboard(game);
        }

        async function loadLeaderboard(game) {
            try {
                const res = await fetch(`/top/${game}`, {credentials: 'include'});
                const leaders = await res.json();
                const list = document.getElementById('leaders-list');
                list.innerHTML = leaders.length ? 
                    leaders.map((p,i) => `<div class="leader-item"><span>${i+1}. ${p.username}</span><span>${p.score}</span></div>`).join('') : 
                    '<div>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
                document.getElementById('leaderboard').style.display = 'block';
            } catch(e) {}
        }

        function loadGuessGame() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            let secret = Math.floor(Math.random() * 100) + 1;
            let attempts = 7;
            let guess = '';
            
            canvas.onclick = () => {};
            
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '24px Arial';
                ctx.fillText(`–£–≥–∞–¥–∞–π: ${guess || '?'} (0-100)`, 20, 50);
                ctx.fillText(`–ü–æ–ø—ã—Ç–æ–∫: ${attempts}`, 20, 100);
                if (attempts === 0) ctx.fillText('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! F5 - –Ω–æ–≤–∞—è', 20, 200);
            }
            
            function checkGuess() {
                const num = parseInt(guess);
                if (isNaN(num) || num < 0 || num > 100) return;
                attempts--;
                if (num === secret) {
                    saveScore('guess', 1000 - (7-attempts)*100);
                    ctx.fillStyle = '#44ff44';
                    ctx.fillText('‚úÖ –ü–û–ë–ï–î–ê! –†–µ–∫–æ—Ä–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 20, 150);
                } else if (attempts === 0) {
                    ctx.fillStyle = '#ff4444';
                    ctx.fillText(`–ë—ã–ª–æ: ${secret}`, 20, 150);
                } else if (num < secret) ctx.fillText('‚¨ÜÔ∏è –ë–æ–ª—å—à–µ!', 20, 150);
                else ctx.fillText('‚¨áÔ∏è –ú–µ–Ω—å—à–µ!', 20, 150);
                guess = ''; draw();
            }
            
            document.addEventListener('keydown', e => {
                if (e.key >= '0' && e.key <= '9') guess += e.key;
                else if (e.key === 'Enter') checkGuess();
                else if (e.key === 'Backspace') guess = guess.slice(0, -1);
                if (currentGame === 'guess') draw();
            });
            draw();
        }

        function loadSnakeGame() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            let snake = [{x: 10, y: 10}];
            let dx = 1, dy = 0;
            let food = {x: 15, y: 15};
            let score = 0;
            
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#44ff44';
                snake.forEach(part => ctx.fillRect(part.x*20, part.y*20, 20, 20));
                ctx.fillStyle = '#ff4444';
                ctx.fillRect(food.x*20, food.y*20, 20, 20);
                ctx.fillStyle = 'white';
                ctx.font = '24px Arial';
                ctx.fillText(`–û—á–∫–∏: ${score}`, 20, 30);
            }
            
            document.addEventListener('keydown', e => {
                if (e.key === 'ArrowUp' && dy === 0) { dx = 0; dy = -1; }
                if (e.key === 'ArrowDown' && dy === 0) { dx = 0; dy = 1; }
                if (e.key === 'ArrowLeft' && dx === 0) { dx = -1; dy = 0; }
                if (e.key === 'ArrowRight' && dx === 0) { dx = 1; dy = 0; }
            });
            
            function gameLoop() {
                const head = {x: snake[0].x + dx, y: snake[0].y + dy};
                snake.unshift(head);
                if (head.x === food.x && head.y === food.y) {
                    score++;
                    food = {x: Math.floor(Math.random()*25), y: Math.floor(Math.random()*20)};
                    if (isLoggedIn) saveScore('snake', score);
                } else snake.pop();
                draw();
                setTimeout(gameLoop, 150);
            }
            gameLoop();
        }

        async function saveScore(game, score) {
            if (!isLoggedIn) { alert('–í–æ–π–¥–∏ –¥–ª—è —Ä–µ–∫–æ—Ä–¥–æ–≤!'); return; }
            try {
                await fetch('/save_score', {
                    method: 'POST', credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({game, score})
                });
            } catch(e) {}
        }

        function showAuth(mode) {
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('modal-title').textContent = mode === 'register' ? 'üìù –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø' : 'üîë –í–•–û–î';
            document.getElementById('username').value = ''; 
            document.getElementById('password').value = '';
            document.getElementById('error').textContent = '';
            document.getElementById('username').focus();
        }

        function closeAuth() { document.getElementById('auth-modal').style.display = 'none'; }

        async function testAPI() {
            const res = await fetch('/test', {credentials: 'include'});
            console.log(await res.json());
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeAuth();
            if (document.getElementById('auth-modal').style.display === 'flex' && e.key === 'Enter') authUser();
        });

        checkUserStatus();
    </script>
</body>
</html>
