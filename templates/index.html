<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–æ–≤–æ–π –•–∞–± –ù–∞–∑–∞—Ä</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>üéÆ –ò–≥—Ä–æ–≤–æ–π –•–∞–± –ù–∞–∑–∞—Ä</h1>
        <div id="user-status">–ì–æ—Å—Ç—å üò¥</div>
        
        <!-- üî• –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ó–î–ï–°–¨ üî• -->
        <div style="margin: 20px 0;">
            <button onclick="showAuth('register')" style="font-size: 1.2em; padding: 15px 30px;">üìù –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
            <button onclick="showAuth('login')" style="font-size: 1.2em; padding: 15px 30px;">üîë –í–•–û–î</button>
            <button onclick="logout()" id="logout-btn" style="display: none; background: #ff4757;">üö™ –í—ã–π—Ç–∏</button>
        </div>
        
        <div class="games">
            <button class="game-btn" onclick="playGame('guess')">üéØ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ</button>
            <button class="game-btn" onclick="playGame('snake')">üêç –ó–º–µ–π–∫–∞</button>
        </div>
        
        <div id="game-area" style="display: none;"></div>
        <div id="leaderboard"></div>
    </div>

    <!-- üî• –ú–û–î–ê–õ–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò üî• -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAuth()">&times;</span>
            <h3 id="modal-title">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h3>
            <input id="username" placeholder="–ò–º—è (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)" maxlength="20">
            <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="30">
            <br><br>
            <button onclick="authUser()" style="font-size: 1.3em; padding: 15px 40px;">‚úÖ –ì–û–¢–û–í–û</button>
            <div id="auth-error" style="color: #ff6b6b; margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        let currentGame = '', isLoggedIn = false, currentUsername = '';

        // –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê
        async function checkUserStatus() {
            try {
                const res = await fetch('/api/user_status');
                const status = await res.json();
                if (status.logged_in) {
                    isLoggedIn = true;
                    currentUsername = status.username;
                    document.getElementById('user-status').textContent = `üëã ${currentUsername}`;
                    document.getElementById('logout-btn').style.display = 'inline-block';
                }
            } catch(e) {}
        }

        // –ü–û–ö–ê–ó–ê–¢–¨ –ú–û–î–ê–õ–ö–£
        function showAuth(type) {
            document.getElementById('modal-title').textContent = type === 'register' ? 'üìù –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø' : 'üîë –í–•–û–î';
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('auth-error').textContent = '';
        }

        function closeAuth() {
            document.getElementById('auth-modal').style.display = 'none';
        }

        // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø/–õ–û–ì–ò–ù
        async function authUser() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (username.length < 3) return document.getElementById('auth-error').textContent = '–ò–º—è ‚â• 3 —Å–∏–º–≤–æ–ª–∞!';
            if (password.length < 6) return document.getElementById('auth-error').textContent = '–ü–∞—Ä–æ–ª—å ‚â• 6 —Å–∏–º–≤–æ–ª–æ–≤!';
            
            const isRegister = document.getElementById('modal-title').textContent.includes('–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø');
            const endpoint = isRegister ? '/api/register' : '/api/login';
            
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                const data = await res.json();
                
                if (data.success) {
                    isLoggedIn = true;
                    currentUsername = data.username || username;
                    document.getElementById('user-status').textContent = `üëã ${currentUsername} ‚úÖ`;
                    document.getElementById('logout-btn').style.display = 'inline-block';
                    closeAuth();
                    location.reload(); // –û–±–Ω–æ–≤–∏—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥
                } else {
                    document.getElementById('auth-error').textContent = data.error || '–û—à–∏–±–∫–∞!';
                }
            } catch(e) {
                document.getElementById('auth-error').textContent = '–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
            }
        }

        async function logout() {
            await fetch('/api/logout', {method: 'POST'});
            location.reload();
        }

        async function loadLeaderboard(game) {
            const res = await fetch(`/api/leaderboard/${game}`);
            const leaders = await res.json();
            let html = '<h3>üèÜ –¢–û–ü-10</h3><ol>';
            leaders.forEach((l, i) => {
                html += `<li>${i+1}. ${l.username}: <b>${l.score}</b> (${l.plays} –∏–≥—Ä)</li>`;
            });
            html += '</ol>';
            document.getElementById('leaderboard').innerHTML = html;
        }

        function playGame(game) {
            currentGame = game;
            loadLeaderboard(game);
            alert(`${game.toUpperCase()} –∑–∞–ø—É—â–µ–Ω–∞! ${isLoggedIn ? '–†–µ–∫–æ—Ä–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è!' : '–ó–∞–ª–æ–≥–∏–Ω—å—Å—è –¥–ª—è —Ç–æ–ø–∞'}`);
        }

        // –°–¢–ê–†–¢
        checkUserStatus();
        document.addEventListener('click', e => e.target.focus());
    </script>
</body>
</html>
