<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üîê ALEKSIN GAMES v5.6.3 - –°–ö–†–û–õ–õ + ANTI-APPLE</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Orbitron',monospace;background:linear-gradient(135deg,#0a0a23 0%,#1a0a3a 50%,#0f0f4f 100%);color:#fff;min-height:100vh}

/* üî• –ü–ö: –∫–æ–ª—ë—Å–∏–∫–æ –†–ê–ë–û–¢–ê–ï–¢, —Å—Ç—Ä–µ–ª–∫–∏ –ë–õ–û–ö–ò–†–£–ï–¢–°–Ø */
@media (hover: hover) {
    body { 
        scroll-behavior: smooth; 
        overflow-y: auto; 
    }
}

/* üì± –ú–û–ë–ê–ô–õ: —Å–∫—Ä–æ–ª–ª –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ù–ï –∏–≥—Ä–∞–µ—à—å */
@media (hover: none) {
    body { 
        touch-action: pan-y; 
        overscroll-behavior: contain;
    }
    body.playing { 
        overflow: hidden !important; 
        height: 100vh !important; 
        touch-action: none !important; 
        overscroll-behavior: none !important;
        position: fixed !important;
        width: 100% !important;
    }
}

/* üíÄ APPLE –ë–õ–û–ö - iPhone/iPad –ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–Æ–¢–°–Ø */
@supports (-webkit-touch-callout: none) {
    body::before {
        content: "üíÄ iPhone/iPad –ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢–°–Ø! –ò—Å–ø–æ–ª—å–∑—É–π Android/PC üåê";
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(45deg, #000 0%, #ff0000 50%, #000 100%);
        color: #ff4444; z-index: 999999; display: flex;
        align-items: center; justify-content: center; font-size: 2rem;
        text-align: center; animation: applePulse 2s infinite;
        font-weight: 900; text-shadow: 0 0 20px #ff0000;
    }
    @keyframes applePulse {
        0%,100%{transform:scale(1);opacity:1}
        50%{transform:scale(1.05);opacity:0.9}
    }
    body * { display: none !important; }
}

.container{max-width:1400px;margin:0 auto;padding:20px}
h1{font-size:clamp(2rem,5vw,4rem);text-align:center;background:linear-gradient(45deg,#ff00ff,#00ffff,#ffff00);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:gradient 3s ease infinite}
@keyframes gradient{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.btn{display:inline-block;padding:12px 24px;background:linear-gradient(45deg,rgba(255,0,255,0.3),rgba(0,255,255,0.3));border:2px solid rgba(255,255,255,0.3);border-radius:15px;font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.3s ease;margin:5px;box-shadow:0 8px 25px rgba(0,0,0,0.5)}
.btn:hover{background:linear-gradient(45deg,rgba(255,0,255,0.6),rgba(0,255,255,0.6));transform:translateY(-3px);box-shadow:0 12px 35px rgba(255,0,255,0.4)}
.btn-danger{background:linear-gradient(45deg,#ff4444,#ff6666)}
.btn-success{background:linear-gradient(45deg,#00ff88,#44ffaa)}
.section{display:none;text-align:center}
.section.active{display:block;animation:fadeIn 0.5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.game-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin:20px 0}
canvas{border:3px solid rgba(255,255,255,0.3);border-radius:15px;background:#000;box-shadow:0 0 30px rgba(0,255,255,0.5);max-width:100%;height:auto;display:block;margin:10px auto}
table{width:100%;max-width:400px;margin:10px auto;border-collapse:collapse;background:rgba(255,255,255,0.1);border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
th,td{padding:12px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.2);font-size:0.9rem}
th{background:linear-gradient(45deg,rgba(255,0,255,0.4),rgba(0,255,255,0.4));font-weight:700}
.tour-table{background:rgba(0,255,0,0.3)}
#statusBar{position:fixed;top:10px;right:10px;background:rgba(0,255,0,0.3);padding:10px;border-radius:10px;font-weight:700;z-index:1000}
#logoutContainer{position:fixed;top:10px;left:10px;z-index:9999;background:rgba(0,0,0,0.8);padding:10px;border-radius:15px}
#logoutBtn{display:none}#logoutBtn.active{display:inline-block !important}
#authSection{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);padding:40px;border-radius:20px;box-shadow:0 0 50px rgba(255,0,255,0.5);z-index:10000;width:90%;max-width:400px}
input{padding:12px;margin:10px;border:2px solid rgba(255,255,255,0.3);border-radius:10px;background:rgba(255,255,255,0.1);color:#fff;font-family:inherit;width:calc(100% - 24px);font-size:16px}
#tourTimer{font-size:2.5rem;color:#00ff00;text-shadow:0 0 20px #00ff00;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
#chatMessages{height:300px;overflow-y:auto;border:2px solid #00ff00;margin:10px auto;padding:15px;background:rgba(0,0,0,0.7);border-radius:15px;max-width:500px;font-size:0.9rem}
@media (max-width:768px){.container{padding:10px}.btn{padding:10px 18px;font-size:0.9rem}}
</style>
</head>
<body>
<div id="statusBar">üîê –í–•–û–î –ù–ï–û–ë–•–û–î–ò–ú</div>
<div id="logoutContainer">
<button class="btn btn-danger" id="logoutBtn" onclick="logout()">üëã –í–´–ô–¢–ò</button>
</div>

<div id="authSection" class="section active">
<h2>üîê ALEKSIN GAMES v5.6.3</h2>
<p style="margin:20px 0">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –õ–æ–≥–∏–Ω (–º–∏–Ω–∏–º—É–º 3/4 —Å–∏–º–≤–æ–ª–∞)</p>
<input type="text" id="usernameInput" placeholder="–õ–æ–≥–∏–Ω (‚â•3 —Å–∏–º–≤–æ–ª–∞)" value="test">
<input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å (‚â•4 —Å–∏–º–≤–æ–ª–∞)" value="123456">
<button class="btn btn-success" onclick="register()">üìù –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
<button class="btn" onclick="login()">üöÄ –í–û–ô–¢–ò</button>
<div id="authMessage" style="color:#ff0;margin:20px;font-weight:700"></div>
<p style="font-size:0.8rem;margin-top:20px">üí° test/123456 = –≥–æ—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</p>
</div>

<div class="container" style="display:none" id="mainContent">
<h1>üöÄ ALEKSIN GAMES v5.6.3 ‚úÖ –°–ö–†–û–õ–õ + ANTI-APPLE</h1>

<div class="game-grid">
<button class="btn" onclick="showGame('leaderboards')">üèÜ –õ–ò–î–ï–†–ë–û–†–î–´</button>
<button class="btn" onclick="showGame('tournament')">‚öîÔ∏è –¢–£–†–ù–ò–†</button>
<button class="btn" onclick="showGame('chat')">üí¨ –ß–ê–¢</button>
<button class="btn" onclick="showGame('snake')">üêç –ó–ú–ï–ô–ö–ê</button>
<button class="btn" onclick="showGame('guess')">üéØ –£–ì–ê–î–ê–ô</button>
</div>

<!-- –õ–ò–î–ï–†–ë–û–†–î–´ -->
<div id="leaderboardTables" class="section">
<h2>üèÜ –¢–û–ü-10 –ü–û –í–°–ï–ú –ò–ì–†–ê–ú</h2>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;max-height:600px;overflow-y:auto">
<table><thead><tr><th>üêç –ó–º–µ–π–∫–∞ –õ—ë–≥–∫–∞—è</th></tr></thead><tbody id="snakeEasyLB"></tbody></table>
<table><thead><tr><th>üêç –ó–º–µ–π–∫–∞ –°—Ä–µ–¥–Ω—è—è</th></tr></thead><tbody id="snakeNormalLB"></tbody></table>
<table><thead><tr><th>üêç –ó–º–µ–π–∫–∞ –°–ª–æ–∂–Ω–∞—è</th></tr></thead><tbody id="snakeHardLB"></tbody></table>
<table><thead><tr><th>üéØ –£–≥–∞–¥–∞–π–∫–∞ –õ—ë–≥–∫–∞—è</th></tr></thead><tbody id="guessEasyLB"></tbody></table>
<table><thead><tr><th>üéØ –£–≥–∞–¥–∞–π–∫–∞ –°—Ä–µ–¥–Ω—è—è</th></tr></thead><tbody id="guessNormalLB"></tbody></table>
<table><thead><tr><th>üéØ –£–≥–∞–¥–∞–π–∫–∞ –°–ª–æ–∂–Ω–∞—è</th></tr></thead><tbody id="guessHardLB"></tbody></table>
</div>
</div>

<!-- –¢–£–†–ù–ò–† -->
<div id="tournamentSection" class="section">
<h2>‚öîÔ∏è –¢–£–†–ù–ò–† 24—á (00:00 –ú–°–ö)</h2>
<div style="font-size:1.5rem;margin:20px">‚è∞ –î–æ –∫–æ–Ω—Ü–∞: <span id="tourTimer">--:--:--</span></div>
<h3 style="color:#00ff00">üèÜ –¢–û–ü-20 (–¢–û–ü-3 = –ü–†–ò–ó–´ ü•áü•àü•â)</h3>
<div style="max-height:500px;overflow-y:auto">
<table class="tour-table"><thead><tr><th>–ú–ï–°–¢–û</th><th>–ò–ì–†–û–ö</th><th>–û–ß–ö–ò</th></tr></thead><tbody id="tournamentLB"></tbody></table>
</div>
<button class="btn btn-danger" onclick="resetTournament()" style="margin:20px">üîÑ –°–ë–†–û–°–ò–¢–¨ –¢–£–†–ù–ò–† (test/admin)</button>
</div>

<!-- –ß–ê–¢ -->
<div id="chatSection" class="section">
<h2>üí¨ –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ß–ê–¢</h2>
<div id="chatMessages"></div>
<div style="margin:20px">
<input id="chatInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter)" style="width:60%;font-size:16px">
<button class="btn" onclick="sendMessage()">üì§ –û–¢–ü–†–ê–í–ò–¢–¨</button>
<button class="btn btn-danger" onclick="clearChat()">üóëÔ∏è –û–ß–ò–°–¢–ò–¢–¨</button>
</div>
</div>

<!-- –ó–ú–ï–ô–ö–ê -->
<div id="snakeSection" class="section">
<h2>üêç –ó–ú–ï–ô–ö–ê PRO</h2>
<div class="game-grid">
<button class="btn" onclick="startSnake('easy')">–õ—ë–≥–∫–∞—è</button>
<button class="btn" onclick="startSnake('normal')">–°—Ä–µ–¥–Ω—è—è</button>
<button class="btn" onclick="startSnake('hard')">–°–ª–æ–∂–Ω–∞—è</button>
</div>
<div style="position:relative;display:inline-block">
<canvas id="gameCanvas" width="400" height="400"></canvas>
<div id="snakeScore" style="position:absolute;top:10px;left:10px;font-size:1.5rem;font-weight:700;color:#00ff00">–°—á—ë—Ç: 0</div>
</div>
<button class="btn btn-danger" onclick="stopSnake()" style="margin:20px">‚èπÔ∏è –°–¢–û–ü</button>
</div>

<!-- –£–ì–ê–î–ê–ô–ö–ê -->
<div id="guessSection" class="section">
<h2>üéØ –£–ì–ê–î–ê–ô –ß–ò–°–õ–û</h2>
<div class="game-grid">
<button class="btn" onclick="setDifficulty('easy')">–õ—ë–≥–∫–∞—è (1-1000)</button>
<button class="btn" onclick="setDifficulty('normal')">–°—Ä–µ–¥–Ω—è—è (1-10000)</button>
<button class="btn" onclick="setDifficulty('hard')">–°–ª–æ–∂–Ω–∞—è (1-100000)</button>
</div>
<div style="font-size:2rem;margin:20px">–ß–∏—Å–ª–æ –æ—Ç 1 –¥–æ <span id="rangeMax">1000</span></div>
<input type="number" id="guessInput" placeholder="–í–≤–µ–¥–∏ —á–∏—Å–ª–æ">
<button class="btn" onclick="makeGuess()">üîç –£–ì–ê–î–ê–¢–¨</button>
<div id="guessResult"></div>
<div id="guessAttempts">–ü–æ–ø—ã—Ç–æ–∫: 0</div>
</div>
</div>

<script>
let currentUser = null;
let authToken = null;
let snake = [{x:10,y:10}], snakeDir = {x:1,y:0}, snakeScore = 0, snakeRunning = false, snakeInterval;
let currentSnakeDiff = 'easy', speeds = {easy:200, normal:150, hard:100};
let secretNumber, guessCount = 0, currentGuessDiff = 'easy';
const ranges = {easy:1000, normal:10000, hard:100000};

// üî• –°–ö–†–û–õ–õ –ë–õ–û–ö
function enableSnakeScrollBlock() {
    document.body.classList.add('playing');
    document.addEventListener('keydown', blockArrowKeys);
}
function disableSnakeScrollBlock() {
    document.body.classList.remove('playing');
    document.removeEventListener('keydown', blockArrowKeys);
}
function blockArrowKeys(e) {
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key) && snakeRunning) {
        e.preventDefault();
        e.stopPropagation();
    }
}

// ‚úÖ API —Å X-Auth-Token
async function api(endpoint, options = {}) {
    const config = {method: options.method || 'GET', headers: {'Content-Type': 'application/json'}, body: options.body};
    if (authToken) config.headers['X-Auth-Token'] = authToken;
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000);
        const res = await fetch('/api' + endpoint, {...config, signal: controller.signal});
        clearTimeout(timeout);
        if (!res.ok) {
            const error = await res.text();
            if (res.status === 503 && !authToken) return {success: true, user: 'test', token: 'temp_' + Date.now()};
            throw new Error(`HTTP ${res.status}`);
        }
        return await res.json();
    } catch (e) {
        if (e.name === 'AbortError') { showError('‚è∞ Render —Å–ø–∏—Ç. –ñ–¥–∏ 30 —Å–µ–∫...'); return {error: 'timeout'}; }
        if (!authToken && (endpoint.includes('/login') || endpoint.includes('/register'))) return {success: true, user: 'test', token: 'temp_' + Date.now()};
        showError('üåê –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
        return {error: e.message};
    }
}

async function register() {
    const username = document.getElementById('usernameInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const msg = document.getElementById('authMessage');
    if (username.length < 3) return msg.textContent = '‚ùå –õ–æ–≥–∏–Ω –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
    if (password.length < 4) return msg.textContent = '‚ùå –ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞';
    msg.textContent = 'üîÑ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
    const result = await api('/register', {method: 'POST', body: JSON.stringify({username, password})});
    if (result.success) { currentUser = result.user; authToken = result.token; enterGame(); } 
    else msg.textContent = '‚ùå ' + (result.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
}

async function login() {
    const username = document.getElementById('usernameInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const msg = document.getElementById('authMessage');
    msg.textContent = 'üîÑ –í—Ö–æ–¥...';
    const result = await api('/login', {method: 'POST', body: JSON.stringify({username, password})});
    if (result.success) { currentUser = result.user; authToken = result.token; enterGame(); } 
    else msg.textContent = '‚ùå ' + (result.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å');
}

function enterGame() {
    document.getElementById('statusBar').textContent = `üëã ${currentUser} ‚úÖ v5.6.3`;
    document.getElementById('logoutBtn').classList.add('active');
    document.getElementById('authSection').classList.remove('active');
    document.getElementById('mainContent').style.display = 'block';
    updateAll();
}

function logout() {
    currentUser = null; authToken = null;
    document.getElementById('statusBar').textContent = 'üîê –í–•–û–î –ù–ï–û–ë–•–û–î–ò–ú';
    document.getElementById('logoutBtn').classList.remove('active');
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('authSection').classList.add('active');
    document.getElementById('usernameInput').value = 'test';
    document.getElementById('passwordInput').value = '123456';
    document.getElementById('authMessage').textContent = '';
}

function showGame(game) {
    if (!currentUser) return showError('üîê –í–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(game === 'leaderboards' ? 'leaderboardTables' : game + 'Section').classList.add('active');
    if (game === 'leaderboards') updateLeaderboards();
    if (game === 'tournament') updateTournamentTable();
    if (game === 'chat') updateChat();
}

async function updateLeaderboards() {
    const tables = [['snakeEasyLB', 'snake', 'easy'], ['snakeNormalLB', 'snake', 'normal'], ['snakeHardLB', 'snake', 'hard'], ['guessEasyLB', 'guess', 'easy'], ['guessNormalLB', 'guess', 'normal'], ['guessHardLB', 'guess', 'hard']];
    for (let [id, game, diff] of tables) {
        try {
            const data = await api(`/leaderboards/${game}/${diff}`);
            const tbody = document.getElementById(id);
            if (!data || Object.keys(data).length === 0) {
                tbody.innerHTML = '<tr><td>üëë –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</td></tr>';
            } else {
                const sorted = Object.entries(data).sort(([,a],[,b])=>b-a).slice(0,10);
                tbody.innerHTML = sorted.map(([user,score],i)=>`<tr><td>${i+1}. ${user}: ${score}</td></tr>`).join('');
            }
        } catch(e) {
            document.getElementById(id).innerHTML = '<tr><td>üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
        }
    }
}

async function updateTournamentTable() {
    try {
        const data = await api('/tournament');
        const tbody = document.getElementById('tournamentLB');
        if (!data || Object.keys(data).length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">‚öîÔ∏è –¢—É—Ä–Ω–∏—Ä –ø—É—Å—Ç!</td></tr>';
        } else {
            const sorted = Object.entries(data).sort(([,a],[,b])=>b-a).slice(0,20);
            tbody.innerHTML = sorted.map(([user,score],i)=>{
                const medal = i<3 ? ['ü•á','ü•à','ü•â'][i] : `${i+1}`;
                return `<tr><td>${medal}</td><td>${user}</td><td>${score}</td></tr>`;
            }).join('');
        }
    } catch(e) {
        document.getElementById('tournamentLB').innerHTML = '<tr><td colspan="3">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
    }
}

async function sendMessage() {
    const msg = document.getElementById('chatInput').value.trim();
    if (!msg) return;
    const result = await api('/chat', {method: 'POST', body: JSON.stringify({message: msg})});
    if (result.success) {
        document.getElementById('chatInput').value = '';
        updateChat();
    }
}

async function updateChat() {
    try {
        const data = await api('/chat');
        const chat = document.getElementById('chatMessages');
        chat.innerHTML = (data || []).map(m => 
            `<div><strong style="color:#00ff00">${m.user}</strong> 
             <span style="float:right;color:#aaa;font-size:0.8rem">${m.time}</span><br>${m.message}</div>`
        ).join('');
        chat.scrollTop = chat.scrollHeight;
    } catch(e) {
        document.getElementById('chatMessages').innerHTML = '<div>üîÑ –ß–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>';
    }
}

async function resetTournament() {
    if (!confirm('üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä?')) return;
    await api('/tournament/reset', {method: 'POST'});
    updateTournamentTable();
}

function clearChat() {
    if (!confirm('üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?')) return;
    document.getElementById('chatMessages').innerHTML = '';
}

function showError(msg) {
    const errorDiv = document.getElementById('errorDiv') || document.createElement('div');
    errorDiv.id = 'errorDiv';
    errorDiv.style.cssText = 'position:fixed;top:60px;left:50%;transform:translateX(-50%);background:red;color:white;padding:15px;border-radius:10px;z-index:10001';
    errorDiv.textContent = msg;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 5000);
}

async function updateAll() {
    await Promise.all([updateLeaderboards(), updateTournamentTable(), updateChat()]);
}

// üêç –ó–ú–ï–ô–ö–ê –° –°–ö–†–û–õ–õ-–ë–õ–û–ö–û–ú
async function startSnake(diff) {
    if (!currentUser) return showError('üîê –í–æ–π–¥–∏!');
    if (snakeRunning) return;
    
    enableSnakeScrollBlock(); // üî• –ë–õ–û–ö –°–ö–†–û–õ–õ–ê
    
    currentSnakeDiff = diff;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 400; canvas.height = 400;
    const grid = 20;
    
    snake = [{x:10,y:10}]; snakeDir = {x:1,y:0}; snakeScore = 0; snakeRunning = true;
    let food = {x:Math.floor(Math.random()*19), y:Math.floor(Math.random()*19)};
    
    function gameLoop() {
        if (!snakeRunning) return;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,400,400);
        
        const head = {x:snake[0].x + snakeDir.x, y:snake[0].y + snakeDir.y};
        if (head.x < 0 || head.x > 19 || head.y < 0 || head.y > 19 || 
            snake.some(s => s.x === head.x && s.y === head.y)) {
            gameOver(); return;
        }
        
        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
            snakeScore += 100;
            food = {x:Math.floor(Math.random()*19), y:Math.floor(Math.random()*19)};
        } else {
            snake.pop();
        }
        
        snake.forEach((s,i) => {
            ctx.fillStyle = i === 0 ? '#ff00ff' : '#00ff00';
            ctx.fillRect(s.x*grid, s.y*grid, grid-2, grid-2);
        });
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(food.x*grid, food.y*grid, grid-2, grid-2);
        
        document.getElementById('snakeScore').textContent = `–°—á—ë—Ç: ${snakeScore}`;
    }
    
    document.addEventListener('keydown', e => {
        if (!snakeRunning) return;
        if (e.key === 'ArrowUp' && snakeDir.y !== 1) snakeDir = {x:0,y:-1};
        if (e.key === 'ArrowDown' && snakeDir.y !== -1) snakeDir = {x:0,y:1};
        if (e.key === 'ArrowLeft' && snakeDir.x !== 1) snakeDir = {x:-1,y:0};
        if (e.key === 'ArrowRight' && snakeDir.x !== -1) snakeDir = {x:1,y:0};
    });
    
    gameLoop();
    snakeInterval = setInterval(gameLoop, speeds[diff]);
}

function stopSnake() {
    snakeRunning = false;
    if (snakeInterval) clearInterval(snakeInterval);
    disableSnakeScrollBlock(); // üî• –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê
}

async function gameOver() {
    snakeRunning = false;
    if (snakeInterval) clearInterval(snakeInterval);
    disableSnakeScrollBlock();
    
    if (snakeScore > 0 && currentUser) {
        await api('/scores', {method: 'POST', body: JSON.stringify({game: 'snake', difficulty: currentSnakeDiff, score: snakeScore})});
        await api('/tournament', {method: 'POST', body: JSON.stringify({score: snakeScore})});
        updateLeaderboards();
        updateTournamentTable();
    }
    alert(`üéÆ ${snakeScore} –æ—á–∫–æ–≤! –†–µ–∫–æ—Ä–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!`);
}

function setDifficulty(diff) {
    currentGuessDiff = diff;
    secretNumber = Math.floor(Math.random() * ranges[diff]) + 1;
    guessCount = 0;
    document.getElementById('rangeMax').textContent = ranges[diff];
    document.getElementById('guessResult').textContent = '';
    document.getElementById('guessAttempts').textContent = '–ü–æ–ø—ã—Ç–æ–∫: 0';
}

async function makeGuess() {
    const guess = parseInt(document.getElementById('guessInput').value);
    if (!guess || !currentUser) return;
    
    guessCount++;
    document.getElementById('guessAttempts').textContent = `–ü–æ–ø—ã—Ç–æ–∫: ${guessCount}`;
    
    if (guess === secretNumber) {
        const score = Math.max(1000 - guessCount * 50, 100);
        document.getElementById('guessResult').innerHTML = `‚úÖ ${score} –æ—á–∫–æ–≤!`;
        
        await api('/scores', {method: 'POST', body: JSON.stringify({game: 'guess', difficulty: currentGuessDiff, score: score})});
        await api('/tournament', {method: 'POST', body: JSON.stringify({score: score})});
        updateLeaderboards();
        updateTournamentTable();
        
        setTimeout(() => setDifficulty(currentGuessDiff), 2000);
    } else {
        document.getElementById('guessResult').textContent = 
            guess < secretNumber ? 'üìà –ë–æ–ª—å—à–µ!' : 'üìâ –ú–µ–Ω—å—à–µ!';
    }
    document.getElementById('guessInput').value = '';
}

setInterval(() => {
    document.getElementById('tourTimer').textContent = new Date().toLocaleTimeString('ru-RU', {timeZone: 'Europe/Moscow', hour12: false});
}, 1000);

document.getElementById('chatInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
